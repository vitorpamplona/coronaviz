<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Location Heatmap</title>
    <link rel="stylesheet" href="style.css">
    <script src="jquery-3.4.1.min.js"></script>
</head>

<body>
    <div id="floating-panel">
        <div class="group">
            <h2>1. <a href="https://takeout.google.com/settings/takeout/custom/location_history">Download</a> your 
				<br>Location History 
				<br>from Google
			</h2>
        </div>

        <div class="group">
            <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">

                <h2>2. Load the Location File</h2>
                <input type='file' id='fileinput' onchange='loadFile();'>

            </form>
        </div>
    </div>
    <div id="map"></div>

    <script>
        function valid(value) {
          return value && Math.abs(value) > 0;
        }

        function processInfectionsFromLancet(allText) {
            var allTextLines = allText.split(/\r\n|\n/);

            console.log("Importing Locations: " + allTextLines.length);

            var headings = allTextLines[0].split(',');

            latIdx = headings.findIndex(element => element === '"latitude"');
            longIdx = headings.findIndex(element => element === '"longitude"');
            symp = headings.findIndex(element => element === '"date_onset_symptoms"');
            admission = headings.findIndex(element => element === '"date_admission_hospital"');
            conf = headings.findIndex(element => element === '"date_confirmation"');

            cityIdx = headings.findIndex(element => element === '"city"');
            provinceIdx = headings.findIndex(element => element === '"province"');
            countryIdx = headings.findIndex(element => element === '"country"');
            		

            var infections = [];

            var idx = 1;
            while (idx < allTextLines.length) {
                var entry = allTextLines[idx].replace(/\"/g, '').split(',');
                if (valid(entry[latIdx]) && valid(entry[longIdx])) {
                    tarr = new google.maps.LatLng(entry[latIdx], entry[longIdx]);
                    infections.push(tarr);
                    //console.log("Logging: " + entry[cityIdx] + ", " + entry[provinceIdx] + ", " + entry[countryIdx]);
                } else {
                    console.log("Lat Long Not Found (" + entry[latIdx] +", " + entry[longIdx] + ") for: " + entry[cityIdx] + ", " + entry[provinceIdx] + ", " + entry[countryIdx]);
                }
                idx++;
            }

            console.log("Infections Found: " + infections.length);

            heatmapInfections = new google.maps.visualization.HeatmapLayer({
                data: infections,
                map: map,
                maxIntensity: 100, // max infections on location
                radius: 10, 
                opacity: 0.7,
                gradient: ["rgba(102, 0, 0, 0)",
                       "rgba(102, 0, 0, 1)",
                       "rgba(147, 0, 0, 1)",
                       "rgba(193, 0, 0, 1)",
                       "rgba(238, 0, 0, 1)",
                       "rgba(244, 0, 0, 1)",
                       "rgba(249, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)"]
            });
        }

        var map, heatmap;

        function loadFile() {
            var input, file, fr;

            if (typeof window.FileReader !== 'function') {
                alert("The file API isn't supported on this browser yet.");
                return;
            }

            input = document.getElementById('fileinput');
            if (!input) {
                alert("Um, couldn't find the fileinput element.");
            } else if (!input.files) {
                alert("This browser doesn't seem to support the `files` property of file inputs.");
            } else if (!input.files[0]) {
                alert("Please select a file before clicking 'Load'");
            } else {
                file = input.files[0];
                fr = new FileReader();
                fr.onload = receivedText;
                fr.readAsText(file);
            }

            function receivedText(e) {
                let lines = e.target.result;
                var newArr = JSON.parse(lines);

                if (newArr.locations) {
                    let locations = newArr.locations.map((val) => {
                        return new google.maps.LatLng(val.latitudeE7 * (10 ** -7), val.longitudeE7 * (10 ** -7));
                    });

                    heatmap = new google.maps.visualization.HeatmapLayer({
                        data: locations,
                        map: map,
                        maxIntensity: 200,
                        radius: 21,
                        opacity: 0.6,
                        gradient: ["rgba(0, 102, 200, 0)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)"]
                    });
                }

                if (newArr.timelineObjects) {
                    let places = newArr.timelineObjects.map((val) => {
                        if (val.placeVisit) {
                            return new google.maps.LatLng(val.placeVisit.location.latitudeE7 * (10 ** -7), val.placeVisit.location.longitudeE7 * (10 ** -7));
                        }
                    });

                    heatmap = new google.maps.visualization.HeatmapLayer({
                        data: places,
                        map: map,
                        maxIntensity: 20,
                        radius: 21,
                        opacity: 1.0,
                        gradient: ["rgba(0, 102, 200, 0)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)",
                         "rgba(0, 102, 200, 1)"]
                    });
                }
            }
        }

        function showPosition(position) {
            map.setCenter({lat:position.coords.latitude, lng:position.coords.longitude});
            map.setZoom(12);
        }

        function initMap() {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(showPosition);
            }

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3,
                center: {
                    lat: 0,
                    lng: 0
                },
                mapTypeId: 'roadmap'
            });

            /* Local Debug 
            processInfectionsFromLancet(
            '"ID","age","sex","city","province","country","wuhan(0)_not_wuhan(1)","latitude","longitude","geo_resolution","date_onset_symptoms","date_admission_hospital","date_confirmation","symptoms","lives_in_Wuhan","travel_history_dates","travel_history_location","reported_market_exposure","additional_information","chronic_disease_binary","chronic_disease","source","sequence_available","outcome","date_death_or_discharge","notes_for_discussion","location","admin3","admin2","admin1","country_new","admin_id","data_moderator_initials","","","","","","","","","","","","","","","","","","",""\r\n'
            + '"1","30","male","Chaohu City, Hefei City","Anhui","China","1","31.64696","117.7166","admin3","18.01.2020","20.01.2020","22.01.2020","","yes","17.01.2020","Wuhan","","","","","http://ah.people.com.cn/GB/n2/2020/0127/c358266-33746566.html","","","","","","Chaohu City","Hefei City","Anhui","China","340181","","","","","","","","","","","","","","","","","","","",""\r\n'
            + '"2","47","male","Baohe District, Hefei City","Anhui","China","1","31.77863","117.3319","admin3","10.01.2020","21.01.2020","23.01.2020","","no","10.01.2020","Chenzhou City, Hunan, via Wuhan","","Google mistranslates the source site as Luzhou","","","http://ah.people.com.cn/GB/n2/2020/0127/c358266-33746566.html","","","","","","Baohe District","Hefei City","Anhui","China","340111","","","","","","","","","","","","","","","","","","","",""\r\n'
            ); */

            /**
              Update this to the Infections datapoints 
             */
            $.ajax({
                type: "GET",
                url: "https://docs.google.com/spreadsheets/d/1itaohdPiAeniCXNlntNztZ_oRvjh0HsGuJXUJWET008/gviz/tq?tqx=out:csv&sheet=outside_Hubei",
                dataType: "text",
                success: function (data) {
                    processInfectionsFromLancet(data);
                }
            });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnsJiBidtS98aT4H_XcphFEyFeJUeDa3w&libraries=visualization&callback=initMap">
    </script>
</body>

</html>