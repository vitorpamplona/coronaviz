<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Location Heatmap</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="floating-panel">
        <div class="group">
			<h2>1. <a href="https://takeout.google.com/settings/takeout/custom/location_history">Download</a> your 
				<br>Location History 
				<br>from Google
			</h2>
        </div>
		
		<div class="group">
			<form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">

		    	<h2>2. Load the Location File</h2>
		     	<input type='file' id='fileinput'>
		     	<input type='button' id='btnLoad' value='Load' onclick='loadFile();'>
		
			</form>
		</div>
    </div>
    <div id="map"></div>
    
    <script>
      const maxI = 200, rad = 21, opac = .6;
      var map, heatmap;
	  
	  function loadFile() {
	    var input, file, fr;

	    if (typeof window.FileReader !== 'function') {
	      alert("The file API isn't supported on this browser yet.");
	      return;
	    }

	    input = document.getElementById('fileinput');
	    if (!input) {
	      alert("Um, couldn't find the fileinput element.");
	    } else if (!input.files) {
	      alert("This browser doesn't seem to support the `files` property of file inputs.");
	    } else if (!input.files[0]) {
	      alert("Please select a file before clicking 'Load'");
	    } else {
	      file = input.files[0];		  
	      fr = new FileReader();
	      fr.onload = receivedText;
	      fr.readAsText(file);
	    }

	    function receivedText(e) {
	      let lines = e.target.result;
	      var newArr = JSON.parse(lines); 
		  
          let locations = newArr.locations.map((val) => {
            return new google.maps.LatLng(val.latitudeE7 * (10 ** -7), val.longitudeE7 * (10 ** -7));
          });
		  
          heatmap = new google.maps.visualization.HeatmapLayer({
            data: locations,
            map: map,
            maxIntensity: maxI,
            radius: rad,
            opacity: opac
          });
	    }
	  }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 37.775, lng: -95.434},
          mapTypeId: 'roadmap'
        });
      }
    </script>
	  
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnsJiBidtS98aT4H_XcphFEyFeJUeDa3w&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>