<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>Corona Virus Intersect</title>

    <link rel="stylesheet" href="./css/style.css">
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./js/lancet_processing.js"></script>
    <script src="./js/google_processor.js"></script>
    <script src="./js/intersect.js"></script>
</head>

<body>
    <div id="floating-panel">
        <div class="group">
            <h2 style="background-color: rgba(238, 0, 0, 1); padding:5px;">Infected</h2>
            <h2 style="background-color: rgba(0, 102, 200, 1); padding:5px;">YOU</h2>
        </div>

        <div class="group">
            <h2>1. <a href="https://takeout.google.com/settings/takeout/custom/location_history">Download</a> your 
				<br>Location History 
				<br>from Google
			</h2>
        </div>

        <div class="group">
            <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
                <h2>2. Load the Location File</h2>
                <input type='file' id='fileinput' onchange='loadFile();'>
            </form>
        </div>

        <div class="group">
            <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
                <h2>3. Calculate Intersections</h2>
                <button type='button' id='calculate' value="" onClick='calculateIntersections();'>Calculate</button>
            </form>
        </div>
    </div>
    <div id="map"></div>

    <script>
        var map, heatmap, heatmapInfections, myLocations, infectedLocations;

        function progress(value) {
            input = document.getElementById('calculate');
            input.innerHTML = "Progress: " + value + "%";
        }
        
        const calculateIntersections = () => {
            risk = intersect(myLocations, infectedLocations, progress);

            heatmapInfections.setMap(null);
            heatmap.setMap(null);

            gData = risk.map((val) => {
                return new google.maps.LatLng(val.lat, val.long);
            });
            heatmapInfections = new google.maps.visualization.HeatmapLayer({
                data: gData,
                map: map,
                maxIntensity: 100, // max infections on location
                radius: 10, 
                opacity: 0.7,
                gradient: ["rgba(102, 0, 0, 0)",
                       "rgba(102, 0, 0, 1)",
                       "rgba(147, 0, 0, 1)",
                       "rgba(193, 0, 0, 1)",
                       "rgba(238, 0, 0, 1)",
                       "rgba(244, 0, 0, 1)",
                       "rgba(249, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)"]
            });
        }

        function loadFile() {
            loadFile

            var input, file, fr;

            if (typeof window.FileReader !== 'function') {
                alert("The file API isn't supported on this browser yet.");
                return;
            }

            input = document.getElementById('fileinput');
            if (!input) {
                alert("Um, couldn't find the fileinput element.");
            } else if (!input.files) {
                alert("This browser doesn't seem to support the `files` property of file inputs.");
            } else if (!input.files[0]) {
                alert("Please select a file before clicking 'Load'");
            } else {
                file = input.files[0];
                fr = new FileReader();
                fr.onload = receivedText;
                fr.readAsText(file);
            }

            function receivedText(e) {
                myLocations = processGoogleTakout(e.target.result);
                gData = myLocations.map((val) => {
                    return new google.maps.LatLng(val.lat, val.long);
                });
                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: gData,
                    map: map,
                    maxIntensity: 200,
                    radius: 10,
                    opacity: 0.6,
                    gradient: ["rgba(0, 102, 200, 0)",
                        "rgba(0, 102, 200, 1)",
                        "rgba(0, 102, 200, 1)",
                        "rgba(0, 102, 200, 1)",
                        "rgba(0, 102, 200, 1)",
                        "rgba(0, 102, 200, 1)"]
                });
            }
        }

        function showPosition(position) {
            map.setCenter({lat:position.coords.latitude, lng:position.coords.longitude});
            map.setZoom(12);
        }

        function buildInfectionLayer(infections) {
            infectedLocations = infections;
            gData = infectedLocations.map((val) => {
                return new google.maps.LatLng(val.lat, val.long);
            });
            heatmapInfections = new google.maps.visualization.HeatmapLayer({
                data: gData,
                map: map,
                maxIntensity: 100, // max infections on location
                radius: 10, 
                opacity: 0.7,
                gradient: ["rgba(102, 0, 0, 0)",
                       "rgba(102, 0, 0, 1)",
                       "rgba(147, 0, 0, 1)",
                       "rgba(193, 0, 0, 1)",
                       "rgba(238, 0, 0, 1)",
                       "rgba(244, 0, 0, 1)",
                       "rgba(249, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)",
                       "rgba(255, 0, 0, 1)"]
            });
        }

        function initMap() {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(showPosition);
            }

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3,
                center: {
                    lat: 0,
                    lng: 0
                },
                mapTypeId: 'roadmap'
            });

            loadLancet(buildInfectionLayer);
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnsJiBidtS98aT4H_XcphFEyFeJUeDa3w&libraries=visualization&callback=initMap">
    </script>
</body>

</html>